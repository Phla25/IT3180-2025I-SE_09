<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Th√¥ng B√°o - Ban Qu·∫£n Tr·ªã - BlueMoon Portal</title>

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        .notification-page {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .feature-badge {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: auto;
            animation: pulse 2s infinite;
        }  
        .notification-form,
        .notification-list {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .notification-form h2 {
            color: var(--primary-color);
            margin-bottom: 16px;
        }

        .notification-form-group {
            margin-bottom: 16px;
        }

        .notification-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .notification-form-group input,
        .notification-form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
        }

        .notification-form button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .notification-item {
            border-bottom: 1px solid #eee;
            padding: 16px 0;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item h3 {
            margin: 0;
            color: var(--text-color);
        }

        .notification-item small {
            color: var(--gray);
        }

        /* Modal ph·∫£n h·ªìi */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .reply-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }

        .reply-item:last-child {
            border-bottom: none;
        }

        .reply-item small {
            color: #888;
        }

        .close-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 20px;
            float: right;
            cursor: pointer;
        }

        .view-reply-btn {
            background: #4F46E5;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        /* Tabs cho th√¥ng b√°o th∆∞·ªùng v√† ƒë·ªãnh k·ª≥ */
        .notification-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .btn-secondary {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-tertiary {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Scheduled notification form */
        .schedule-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }

        .schedule-config select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
        }

        .time-inputs {
            display: flex;
            gap: 10px;
        }

        .time-inputs input {
            width: 80px;
        }

        .scheduled-item {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-color);
        }

        .scheduled-item h4 {
            margin: 0 0 8px 0;
            color: var(--text-color);
        }

        .scheduled-item .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .badge-active {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-weekly {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-monthly {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-yearly {
            background: #e9d5ff;
            color: #6b21a8;
        }

        .scheduled-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
        }

        .btn-toggle {
            background: #f59e0b;
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-building"></i>
                <span>BlueMoon Portal</span>
            </div>
            <div class="user-profile">
                <div class="user-info">
                    <span class="user-name" th:text="${user?.hoVaTen} ?: 'T√™n Ng∆∞·ªùi D√πng'">T√™n Ng∆∞·ªùi D√πng</span>
                    <span class="user-role" style="color: #7C3AED;">BAN QU·∫¢N TR·ªä</span>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a th:href="@{/admin/dashboard}" class="nav-item"> <i class="fas fa-chart-line"></i> <span>Dashboard</span> </a>
            <a th:href="@{/admin/resident-list}" class="nav-item"> <i class="fas fa-users"></i> <span>Qu·∫£n L√Ω C∆∞ D√¢n</span> </a>
            <a th:href="@{/admin/apartment-list}" class="nav-item"> <i class="fas fa-home"></i> <span>Qu·∫£n L√Ω CƒÉn H·ªô</span> </a>
            <a th:href="@{/admin/household-list}" class="nav-item"> <i class="fas fa-users-cog"></i> <span>Qu·∫£n L√Ω H·ªô Gia ƒê√¨nh</span> </a>
            <a th:href="@{/admin/general-asset-list}" class="nav-item"> <i class="fas fa-building"></i> <span>Qu·∫£n L√Ω T√†i S·∫£n</span> </a>
            <a th:href="@{/admin/fees}" class="nav-item"> <i class="fas fa-file-invoice-dollar"></i> <span>Qu·∫£n L√Ω Kho·∫£n Ph√≠</span> </a>
            <a th:href="@{/admin/service-list}" class="nav-item"><i class="fas fa-concierge-bell"></i><span>Qu·∫£n L√Ω D·ªãch V·ª•</span></a>
            <a th:href="@{/admin/service-registrations}" class="nav-item">
                <i class="fas fa-clipboard-list"></i>
                <span>Qu·∫£n L√Ω ƒêƒÉng K√Ω D·ªãch V·ª•</span>
                <span class="feature-badge">M·ªöI</span>
            </a>
            <a href="#" class="nav-item"> <i class="fas fa-exclamation-triangle"></i> <span>X·ª≠ L√Ω S·ª± C·ªë</span> </a>
            <a th:href="@{/admin/notifications}" class="nav-item active">
                <i class="fas fa-bell"></i><span>Qu·∫£n L√Ω Th√¥ng B√°o</span>
            </a>
            <a th:href="@{/admin/reports}" class="nav-item"> <i class="fas fa-chart-bar"></i> <span>B√°o C√°o Th·ªëng K√™</span> </a>
        </nav>

        <div class="sidebar-footer">
            <form th:action="@{/logout}" method="post" style="margin: 0;">
                <button type="submit" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t
                </button>
            </form>
        </div>
    </aside>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="menu-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <h1>Qu·∫£n L√Ω Th√¥ng B√°o</h1>
        </div>
        <div class="header-right">
            <div class="user-menu">
                <div class="user-info">
                    <span class="user-name" th:text="${user != null ? user.hoVaTen : 'Ban Qu·∫£n Tr·ªã'}">Ban Qu·∫£n Tr·ªã</span>
                    <span class="user-role" style="color: #7C3AED;">BAN QU·∫¢N TR·ªä</span>
                </div>
                <div class="user-avatar"><i class="fas fa-user-circle"></i></div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <section class="notification-page">
            <!-- TABS -->
            <div class="notification-tabs">
                <button class="tab-btn active" onclick="switchTab('normal')">
                    <i class="fas fa-bell"></i> Th√¥ng B√°o Th∆∞·ªùng
                </button>
                <button class="tab-btn" onclick="switchTab('scheduled')">
                    <i class="fas fa-clock"></i> Th√¥ng B√°o ƒê·ªãnh K·ª≥
                </button>
            </div>

            <!-- TAB TH√îNG B√ÅO TH∆Ø·ªúNG -->
            <div id="normalTab" class="tab-content active">
                <!-- FORM G·ª¨I TH√îNG B√ÅO TH∆Ø·ªúNG -->
                <div class="notification-form">
                    <h2>üì¢ G·ª≠i Th√¥ng B√°o M·ªõi</h2>
                    <form th:action="@{/admin/notifications/send}" method="post">
                        <div class="notification-form-group">
                            <label for="tieuDe">Ti√™u ƒë·ªÅ</label>
                            <input type="text" id="tieuDe" name="tieuDe" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ th√¥ng b√°o..." required>
                        </div>
                        <div class="notification-form-group">
                            <label for="noiDung">N·ªôi dung</label>
                            <textarea id="noiDung" name="noiDung" rows="5" placeholder="Nh·∫≠p n·ªôi dung th√¥ng b√°o..." required></textarea>
                        </div>
                        <button type="submit"><i class="fas fa-paper-plane"></i> G·ª≠i Th√¥ng B√°o Ngay</button>
                    </form>
                </div>

                <!-- DANH S√ÅCH TH√îNG B√ÅO TH∆Ø·ªúNG -->
                <div class="notification-list">
                    <h2>üìú Danh S√°ch Th√¥ng B√°o G·∫ßn ƒê√¢y</h2>

                    <div th:if="${#lists.isEmpty(thongBaos)}" style="text-align: center; color: var(--gray); padding: 20px;">
                        Hi·ªán ch∆∞a c√≥ th√¥ng b√°o n√†o.
                    </div>

                    <div th:each="tb : ${thongBaos}" class="notification-item">
                        <h3 th:text="${tb.tieuDe}">Ti√™u ƒë·ªÅ th√¥ng b√°o</h3>
                        <p th:text="${tb.noiDung}">N·ªôi dung th√¥ng b√°o...</p>
                        <small>
                            üïí <span th:text="${#temporals.format(tb.thoiGianGui, 'dd/MM/yyyy HH:mm')}">01/10/2025</span> -
                            üë§ <span th:text="${tb.nguoiGui != null ? tb.nguoiGui.hoVaTen : 'H·ªá th·ªëng'}">Ban Qu·∫£n Tr·ªã</span>
                        </small>
                        <br>
                        <button class="view-reply-btn" th:attr="data-id=${tb.maThongBao}" onclick="openRepliesModal(this)">üí¨ Xem ph·∫£n h·ªìi</button>
                    </div>
                </div>
            </div>

            <!-- TAB TH√îNG B√ÅO ƒê·ªäNH K·ª≤ -->
            <div id="scheduledTab" class="tab-content">
                <!-- FORM T·∫†O TH√îNG B√ÅO ƒê·ªäNH K·ª≤ -->
                <div class="notification-form">
                    <h2>üîÑ T·∫°o Th√¥ng B√°o ƒê·ªãnh K·ª≥</h2>
                    <form id="scheduledNotificationForm">
                        <div class="notification-form-group">
                            <label for="tieuDeDinhKy">Ti√™u ƒë·ªÅ</label>
                            <input type="text" id="tieuDeDinhKy" name="tieuDe" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ th√¥ng b√°o ƒë·ªãnh k·ª≥..." required>
                        </div>
                        
                        <div class="notification-form-group">
                            <label for="loaiThongBaoDinhKy">Lo·∫°i th√¥ng b√°o</label>
                            <select id="loaiThongBaoDinhKy" name="loaiThongBao" required>
                                <option value="">-- Ch·ªçn lo·∫°i th√¥ng b√°o --</option>
                                <option value="bao_tri_tai_san">üîß B·∫£o tr√¨ t√†i s·∫£n</option>
                                <option value="bao_tri_dich_vu">üõ†Ô∏è B·∫£o tr√¨ d·ªãch v·ª•</option>
                                <option value="bao_tri_chung_cu">üè¢ B·∫£o tr√¨ chung c∆∞</option>
                                <option value="thong_bao_chung">üì¢ Th√¥ng b√°o chung</option>
                            </select>
                        </div>
                        
                        <div class="notification-form-group">
                            <label for="noiDungDinhKy">N·ªôi dung</label>
                            <textarea id="noiDungDinhKy" name="noiDung" rows="5" placeholder="Nh·∫≠p n·ªôi dung th√¥ng b√°o ƒë·ªãnh k·ª≥..." required></textarea>
                        </div>

                        <div class="schedule-config">
                            <div class="notification-form-group">
                                <label for="chuKy">Chu k·ª≥</label>
                                <select id="chuKy" name="chuKy" required onchange="updateScheduleFields()">
                                    <option value="">-- Ch·ªçn chu k·ª≥ --</option>
                                    <option value="HANG_TUAN">H√†ng tu·∫ßn</option>
                                    <option value="HANG_THANG">H√†ng th√°ng</option>
                                    <option value="HANG_NAM">H√†ng nƒÉm</option>
                                </select>
                            </div>

                            <!-- C·∫•u h√¨nh cho t·ª´ng chu k·ª≥ -->
                            <div id="weeklyConfig" class="notification-form-group" style="display: none;">
                                <label for="thuTrongTuan">Th·ª© trong tu·∫ßn</label>
                                <select id="thuTrongTuan" name="thuTrongTuan">
                                    <option value="1">Ch·ªß nh·∫≠t</option>
                                    <option value="2" selected>Th·ª© 2</option>
                                    <option value="3">Th·ª© 3</option>
                                    <option value="4">Th·ª© 4</option>
                                    <option value="5">Th·ª© 5</option>
                                    <option value="6">Th·ª© 6</option>
                                    <option value="7">Th·ª© 7</option>
                                </select>
                            </div>

                            <div id="monthlyConfig" class="notification-form-group" style="display: none;">
                                <label for="ngayTrongThang">Ng√†y trong th√°ng</label>
                                <input type="number" id="ngayTrongThang" name="ngayTrongThang" min="1" max="31" value="1">
                            </div>

                            <div id="yearlyConfig" class="notification-form-group" style="display: none;">
                                <label for="thangTrongNam">Th√°ng</label>
                                <select id="thangTrongNam" name="thangTrongNam">
                                    <option value="1" selected>Th√°ng 1</option>
                                    <option value="2">Th√°ng 2</option>
                                    <option value="3">Th√°ng 3</option>
                                    <option value="4">Th√°ng 4</option>
                                    <option value="5">Th√°ng 5</option>
                                    <option value="6">Th√°ng 6</option>
                                    <option value="7">Th√°ng 7</option>
                                    <option value="8">Th√°ng 8</option>
                                    <option value="9">Th√°ng 9</option>
                                    <option value="10">Th√°ng 10</option>
                                    <option value="11">Th√°ng 11</option>
                                    <option value="12">Th√°ng 12</option>
                                </select>
                            </div>

                            <div id="yearlyDayConfig" class="notification-form-group" style="display: none;">
                                <label for="ngayTrongNam">Ng√†y</label>
                                <input type="number" id="ngayTrongNam" name="ngayTrongNam" min="1" max="31" value="1">
                            </div>

                            <div class="notification-form-group">
                                <label>Th·ªùi gian g·ª≠i</label>
                                <div class="time-inputs">
                                    <input type="number" id="gioGui" name="gioGui" min="0" max="23" value="9" placeholder="Gi·ªù" required>
                                    <span>:</span>
                                    <input type="number" id="phutGui" name="phutGui" min="0" max="59" value="0" placeholder="Ph√∫t" required>
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button type="submit" class="notification-form button">
                                <i class="fas fa-save"></i> T·∫°o Th√¥ng B√°o ƒê·ªãnh K·ª≥
                            </button>
                        </div>
                    </form>
                </div>

                <!-- DANH S√ÅCH TH√îNG B√ÅO ƒê·ªäNH K·ª≤ -->
                <div class="notification-list">
                    <h2>üìã Danh S√°ch Th√¥ng B√°o ƒê·ªãnh K·ª≥</h2>
                    <div id="scheduledNotificationsList">
                        <p style="text-align: center; color: var(--gray); padding: 20px;">ƒêang t·∫£i...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- MODAL PH·∫¢N H·ªíI -->
    <div id="replyModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeRepliesModal()">&times;</button>
            <h3>üí¨ Ph·∫£n H·ªìi C∆∞ D√¢n</h3>
            <div id="replyList">
                <p>ƒêang t·∫£i ph·∫£n h·ªìi...</p>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 BlueMoon Apartment Management System. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Check for success/error messages from redirect
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('success') === 'true') {
            Swal.fire({
                icon: 'success',
                title: 'Th√†nh c√¥ng!',
                text: 'Th√¥ng b√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn c∆∞ d√¢n.',
                confirmButtonColor: '#4F46E5'
            }).then(() => {
                // Remove query params from URL
                window.history.replaceState({}, document.title, window.location.pathname);
            });
        }
        
        // Check for flash attributes (error messages)
        const errorMsg = /*[[${error}]]*/ null;
        if (errorMsg) {
            Swal.fire({
                icon: 'error',
                title: 'L·ªói!',
                text: errorMsg,
                confirmButtonColor: '#ef4444'
            });
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
        }

        // === TAB SWITCHING ===
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            if (tabName === 'normal') {
                document.getElementById('normalTab').classList.add('active');
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
            } else if (tabName === 'scheduled') {
                document.getElementById('scheduledTab').classList.add('active');
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                loadScheduledNotifications();
            }
        }

        // === SCHEDULED NOTIFICATION FORM ===
        function updateScheduleFields() {
            const chuKy = document.getElementById('chuKy').value;
            
            // Hide all config fields
            document.getElementById('weeklyConfig').style.display = 'none';
            document.getElementById('monthlyConfig').style.display = 'none';
            document.getElementById('yearlyConfig').style.display = 'none';
            document.getElementById('yearlyDayConfig').style.display = 'none';

            // Show relevant fields
            if (chuKy === 'HANG_TUAN') {
                document.getElementById('weeklyConfig').style.display = 'block';
            } else if (chuKy === 'HANG_THANG') {
                document.getElementById('monthlyConfig').style.display = 'block';
            } else if (chuKy === 'HANG_NAM') {
                document.getElementById('yearlyConfig').style.display = 'block';
                document.getElementById('yearlyDayConfig').style.display = 'block';
            }
        }

        // Submit scheduled notification form
        document.getElementById('scheduledNotificationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                tieuDe: document.getElementById('tieuDeDinhKy').value,
                noiDung: document.getElementById('noiDungDinhKy').value,
                loaiThongBao: document.getElementById('loaiThongBaoDinhKy').value,
                chuKy: document.getElementById('chuKy').value,
                gioGui: parseInt(document.getElementById('gioGui').value),
                phutGui: parseInt(document.getElementById('phutGui').value),
                laDinhKy: true
            };

            // Add cycle-specific fields
            if (formData.chuKy === 'HANG_TUAN') {
                formData.thuTrongTuan = parseInt(document.getElementById('thuTrongTuan').value);
            } else if (formData.chuKy === 'HANG_THANG') {
                formData.ngayTrongThang = parseInt(document.getElementById('ngayTrongThang').value);
            } else if (formData.chuKy === 'HANG_NAM') {
                formData.thangTrongNam = parseInt(document.getElementById('thangTrongNam').value);
                formData.ngayTrongNam = parseInt(document.getElementById('ngayTrongNam').value);
            }

            console.log('Sending scheduled notification:', formData);
            
            fetch('/admin/notifications/scheduled/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json().then(data => ({
                    status: response.status,
                    ok: response.ok,
                    data: data
                }));
            })
            .then(result => {
                console.log('Response data:', result);
                if (!result.ok) {
                    throw new Error(result.data.error || 'Kh√¥ng th·ªÉ t·∫°o th√¥ng b√°o ƒë·ªãnh k·ª≥');
                }
                Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng!',
                    text: 'ƒê√£ t·∫°o th√¥ng b√°o ƒë·ªãnh k·ª≥',
                    confirmButtonColor: '#4F46E5'
                });
                document.getElementById('scheduledNotificationForm').reset();
                loadScheduledNotifications();
            })
            .catch(error => {
                console.error('Error creating scheduled notification:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói!',
                    text: error.message || 'Kh√¥ng th·ªÉ t·∫°o th√¥ng b√°o ƒë·ªãnh k·ª≥',
                    confirmButtonColor: '#ef4444'
                });
            });
        });

        // Load scheduled notifications
        function loadScheduledNotifications() {
            const container = document.getElementById('scheduledNotificationsList');
            container.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">ƒêang t·∫£i...</p>';

            fetch('/admin/notifications/scheduled/list')
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">Ch∆∞a c√≥ th√¥ng b√°o ƒë·ªãnh k·ª≥ n√†o.</p>';
                        return;
                    }

                    container.innerHTML = data.map(item => {
                        const chuKyBadge = getChuKyBadge(item.chuKy);
                        const loaiBadge = getLoaiBadge(item.loaiThongBao);
                        const statusBadge = item.trangThaiHoatDong ? 
                            '<span class="badge badge-active">ƒêang ho·∫°t ƒë·ªông</span>' : 
                            '<span class="badge badge-inactive">T·∫°m d·ª´ng</span>';
                        
                        const scheduleInfo = getScheduleInfo(item);
                        const nextSend = item.ngayGuiTiepTheo ? 
                            new Date(item.ngayGuiTiepTheo).toLocaleString('vi-VN') : 
                            'Ch∆∞a x√°c ƒë·ªãnh';

                        return `
                            <div class="scheduled-item">
                                <h4>${item.tieuDe}</h4>
                                <p>${item.noiDung}</p>
                                <div style="margin: 8px 0;">
                                    ${statusBadge}
                                    ${chuKyBadge}
                                    ${loaiBadge}
                                </div>
                                <small>
                                    üìÖ ${scheduleInfo} | 
                                    ‚è∞ ${item.gioGui}:${String(item.phutGui).padStart(2, '0')} | 
                                    üîî L·∫ßn g·ª≠i ti·∫øp: ${nextSend}
                                </small>
                                <div class="scheduled-actions">
                                    <button class="btn-small btn-toggle" onclick="toggleScheduledNotification(${item.maThongBao})">
                                        ${item.trangThaiHoatDong ? 'T·∫°m d·ª´ng' : 'K√≠ch ho·∫°t'}
                                    </button>
                                    <button class="btn-small btn-delete" onclick="deleteScheduledNotification(${item.maThongBao})">
                                        X√≥a
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                })
                .catch(error => {
                    container.innerHTML = '<p style="text-align: center; color: red; padding: 20px;">L·ªói khi t·∫£i danh s√°ch</p>';
                });
        }

        function getChuKyBadge(chuKy) {
            const badges = {
                'HANG_TUAN': '<span class="badge badge-weekly">H√†ng tu·∫ßn</span>',
                'HANG_THANG': '<span class="badge badge-monthly">H√†ng th√°ng</span>',
                'HANG_NAM': '<span class="badge badge-yearly">H√†ng nƒÉm</span>'
            };
            return badges[chuKy] || '';
        }
        
        function getLoaiBadge(loai) {
            const badges = {
                'bao_tri_tai_san': '<span class="badge" style="background: #F59E0B;">üîß B·∫£o tr√¨ t√†i s·∫£n</span>',
                'bao_tri_dich_vu': '<span class="badge" style="background: #10B981;">üõ†Ô∏è B·∫£o tr√¨ d·ªãch v·ª•</span>',
                'bao_tri_chung_cu': '<span class="badge" style="background: #3B82F6;">üè¢ B·∫£o tr√¨ chung c∆∞</span>',
                'thong_bao_chung': '<span class="badge" style="background: #6B7280;">üì¢ Th√¥ng b√°o chung</span>',
                'binh_thuong': '<span class="badge" style="background: #6B7280;">üì¢ B√¨nh th∆∞·ªùng</span>',
                'quan_trong': '<span class="badge" style="background: #EF4444;">‚ö†Ô∏è Quan tr·ªçng</span>',
                'khan_cap': '<span class="badge" style="background: #DC2626;">üö® Kh·∫©n c·∫•p</span>'
            };
            return badges[loai] || '';
        }

        function getScheduleInfo(item) {
            if (item.chuKy === 'HANG_TUAN') {
                const days = ['Ch·ªß nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
                return `M·ªói ${days[item.thuTrongTuan - 1]}`;
            } else if (item.chuKy === 'HANG_THANG') {
                return `Ng√†y ${item.ngayTrongThang} h√†ng th√°ng`;
            } else if (item.chuKy === 'HANG_NAM') {
                return `Ng√†y ${item.ngayTrongNam}/${item.thangTrongNam} h√†ng nƒÉm`;
            }
            return '';
        }

        function toggleScheduledNotification(id) {
            fetch(`/admin/notifications/scheduled/${id}/toggle`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng!',
                    text: data.trangThaiHoatDong ? 'ƒê√£ k√≠ch ho·∫°t th√¥ng b√°o' : 'ƒê√£ t·∫°m d·ª´ng th√¥ng b√°o',
                    confirmButtonColor: '#4F46E5'
                });
                loadScheduledNotifications();
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói!',
                    text: 'Kh√¥ng th·ªÉ thay ƒë·ªïi tr·∫°ng th√°i',
                    confirmButtonColor: '#ef4444'
                });
            });
        }

        function deleteScheduledNotification(id) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√¥ng b√°o ƒë·ªãnh k·ª≥ n√†y?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/admin/notifications/scheduled/${id}/delete`, {
                        method: 'DELETE'
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Delete failed');
                        Swal.fire({
                            icon: 'success',
                            title: 'ƒê√£ x√≥a!',
                            text: 'Th√¥ng b√°o ƒë·ªãnh k·ª≥ ƒë√£ ƒë∆∞·ª£c x√≥a',
                            confirmButtonColor: '#4F46E5'
                        });
                        loadScheduledNotifications();
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'L·ªói!',
                            text: 'Kh√¥ng th·ªÉ x√≥a th√¥ng b√°o',
                            confirmButtonColor: '#ef4444'
                        });
                    });
                }
            });
        }

        // === Modal ph·∫£n h·ªìi ===
        const modal = document.getElementById('replyModal');
        const replyList = document.getElementById('replyList');

        function openRepliesModal(btn) {
            const id = btn.getAttribute('data-id');
            modal.style.display = 'flex';
            replyList.innerHTML = "<p>ƒêang t·∫£i ph·∫£n h·ªìi...</p>";

            fetch(`/admin/notifications/${id}/replies`)
                .then(res => res.json())
                .then(data => {
                    if (data.length === 0) {
                        replyList.innerHTML = "<p style='color:gray;'>Ch∆∞a c√≥ ph·∫£n h·ªìi n√†o.</p>";
                    } else {
                        replyList.innerHTML = data.map(r => {
                            const formattedDate = r.thoiGianGui ? r.thoiGianGui.replace('T', ' ').substring(0, 16) : 'N/A';
                            
                            return `
                                <div class='reply-item'>
                                    <p><strong>${r.hoVaTenNguoiGui}</strong> (${r.vaiTroNguoiGui})</p>
                                    <p>${r.noiDung}</p>
                                    <small>üïí ${formattedDate}</small>
                                </div>
                            `;
                        }).join('');
                    }
                })
                .catch(() => {
                    replyList.innerHTML = "<p style='color:red;'>L·ªói khi t·∫£i ph·∫£n h·ªìi.</p>";
                });
        }

        function closeRepliesModal() {
            modal.style.display = 'none';
        }

        window.onclick = function (event) {
            if (event.target === modal) modal.style.display = 'none';
        }
    </script>
</body>
</html>